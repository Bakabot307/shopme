<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
    <head>
        <meta charset="utf-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>Login - SB Admin</title>
        <link href="/adminss/dist/css/styles.css" rel="stylesheet" />
        <script src="https://use.fontawesome.com/releases/v6.1.0/js/all.js" crossorigin="anonymous"></script>
    </head>
    <body class="bg-primary">
        <div id="layoutAuthentication">
            <div id="layoutAuthentication_content">
                <main>
                    <div class="container">
                        <div class="row justify-content-center">
                            <div class="col-lg-5">
                                <div class="card shadow-lg border-0 rounded-lg mt-5">
                                    <div class="card-header"><h3 class="text-center font-weight-light my-4">Register</h3></div>
                                    <div class="card-body">
                                       	<form th:action="@{/create_customer}" method="post" th:object="${customer}"
                                              style="max-width: 600px; margin: 0 auto"
                                              onsubmit="return checkEmailUnique(this);">
                                            <div class="border border-secondary rounded p-3">
                                                <div class="form-group row">
                                                    <label class="col-sm-4 col-form-label">Fullname:</label>
                                                    <div class="col-sm-8">
                                                        <input type="text" th:field="*{fullname}" class="form-control"
                                                               required="required" maxlength="45" minlength="2" />
                                                    </div>
                                                </div>
                                                <div class="form-group row">
                                                    <label class="col-sm-4 col-form-label">E-mail:</label>
                                                    <div class="col-sm-8">
                                                        <input type="email" th:field="*{email}" class="form-control"
                                                               required="required" maxlength="45" minlength="8" />
                                                        <span class="error" id="error-email"></span>
                                                    </div>
                                                </div>
                                                <div class="form-group row">
                                                    <label class="col-sm-4 col-form-label">Username:</label>
                                                    <div class="col-sm-8">
                                                        <input type="text" th:field="*{username}" class="form-control"
                                                               required="required" maxlength="45" minlength="2" />
                                                        <span class="error" id="error-username"></span>
                                                    </div>
                                                </div>
                                                <div class="form-group row">
                                                    <label class="col-sm-4 col-form-label">Password:</label>
                                                    <div class="col-sm-8">
                                                        <input type="password" th:field="*{password}" class="form-control"
                                                               required="required" maxlength="15" minlength="6"
                                                               oninput="checkPasswordMatch(document.getElementById('confirmPassword'))"
                                                               />
                                                    </div>
                                                </div>

                                                <div class="form-group row">
                                                    <label class="col-sm-4 col-form-label">Re-type Password:</label>
                                                    <div class="col-sm-8">
                                                        <input type="password" id="confirmPassword" class="form-control"
                                                               required="required" maxlength="15" minlength="6"
                                                               oninput="checkPasswordMatch(this)"
                                                               />
                                                    </div>
                                                </div>

                                                <div class="form-group row">
                                                    <label class="col-sm-4 col-form-label">Phone Number:</label>
                                                    <div class="col-sm-8">
                                                        <input type="text" th:field="*{phoneNumber}" class="form-control"
                                                               required="required" maxlength="15" minlength="8" />
                                                    </div>
                                                </div>

                                                <div class="form-group row">
                                                    <label class="col-sm-4 col-form-label">Address Line 1:</label>
                                                    <div class="col-sm-8">
                                                        <input type="text" th:field="*{addressLine1}" class="form-control"
                                                               required="required" maxlength="64" minlength="3" />
                                                    </div>
                                                </div>

                                                <div class="form-group row">
                                                    <label class="col-sm-4 col-form-label">Address Line 2:</label>
                                                    <div class="col-sm-8">
                                                        <input type="text" th:field="*{addressLine2}" class="form-control"
                                                               maxlength="64" />
                                                    </div>
                                                </div>

                                                <div class="form-group row">
                                                    <label class="col-sm-4 col-form-label">City:</label>
                                                    <div class="col-sm-8">
                                                        <input type="text" th:field="*{city}" class="form-control"
                                                               maxlength="45" minlength="2" />
                                                    </div>
                                                </div>

                                                <div class="form-group row">
                                                    <label class="col-sm-4 col-form-label">Country:</label>
                                                    <div class="col-sm-8">
                                                        <select class="form-control" th:field="*{country}">
                                                            <th:block th:each="country : ${listCountries}">
                                                                <option th:value="${country.id}">[[${country.name}]]</option>
                                                            </th:block>
                                                        </select>
                                                    </div>
                                                </div>

                                                <div class="form-group row">
                                                    <label class="col-sm-4 col-form-label">State/Province:</label>
                                                    <div class="col-sm-8">
                                                        <input type="text" th:field="*{state}" class="form-control"
                                                               maxlength="45" minlength="3" list="listStates" />
                                                        <datalist id="listStates"></datalist>
                                                    </div>
                                                </div>

                                                <div class="form-group row">
                                                    <label class="col-sm-4 col-form-label">Postal Code:</label>
                                                    <div class="col-sm-8">
                                                        <input type="text" th:field="*{postalCode}" class="form-control"
                                                               maxlength="10" minlength="2" />
                                                    </div>
                                                </div>
                                                <span class="error" id="error"></span>
                                                <div class="text-center">
                                                    <input type="submit" value="Create Account" class="btn btn-primary" />
                                                </div>
                                            </div>
                                        </form>
                                    </div>
                                    <div class="card-footer text-center py-3">
                                        <div class="small"><a th:href="@{/shop/login}">Already have an account? Sign in!</a></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
            <div id="layoutAuthentication_footer">
                <footer class="py-4 bg-light mt-auto">
                    <div class="container-fluid px-4">
                        <div class="d-flex align-items-center justify-content-between small">
                            <div class="text-muted">Copyright &copy; Your Website 2022</div>
                            <div>
                                <a href="#">Privacy Policy</a>
                                &middot;
                                <a href="#">Terms &amp; Conditions</a>
                            </div>
                        </div>
                    </div>
                </footer>
            </div>

        </div>
        <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
        <script th:src="@{/adminss/src/js/scripts.js}"></script>
        <script type="text/javascript">
                                                  contextPath = "[[@{/}]]";

                                                  var dropDownCountry;
                                                  var dataListState;
                                                  var fieldState;

                                                  $(document).ready(function () {
                                                      dropDownCountry = $("#country");
                                                      dataListState = $("#listStates");
                                                      fieldState = $("#state");

                                                      dropDownCountry.on("change", function () {
                                                          loadStatesForCountry();
                                                          fieldState.val("").focus();
                                                      });
                                                  });

                                                  function loadStatesForCountry() {
                                                      selectedCountry = $("#country option:selected");
                                                      countryId = selectedCountry.val();
                                                      url = contextPath + "shop/register/list_states_by_country/" + countryId;

                                                      $.get(url, function (responseJSON) {
                                                          dataListState.empty();

                                                          $.each(responseJSON, function (index, state) {
                                                              $("<option>").val(state.name).text(state.name).appendTo(dataListState);
                                                          });

                                                      }).fail(function () {
                                                          alert('failed to connect to the server!');
                                                      });
                                                  }

                                                  function checkPasswordMatch(confirmPassword) {
                                                      if (confirmPassword.value != $("#password").val()) {
                                                          confirmPassword.setCustomValidity("Passwords do not match!");
                                                      } else {
                                                          confirmPassword.setCustomValidity("");
                                                      }
                                                  }
                                                  function checkEmailUnique(form) {
                                                      url = contextPath + "shop/register/check_unique";
                                                      customerEmail = $("#email").val();
                                                      customerUsername = $("#username").val();
                                                      csrfValue = $("input[name='_csrf']").val();
                                                      console.log("test")
                                                      params = {
                                                          email: customerEmail,
                                                          username: customerUsername,
                                                          _csrf: csrfValue
                                                      };
                                                    const errorEmail = document.getElementById("error-email") 
                                                    const errorUsername = document.getElementById("error-username") 
                                                     const error = document.getElementById("error") 
                                                      $.post(url, params, function (response) {
                                                          console.log(response);
                                                          if (response === "bothOk") {
                                                              form.submit();
                                                          } else if (response === "bothDuplicated") {
                                                              errorEmail.innerHTML = ("There is another user registered with email " + customerEmail);
                                                              errorUsername.innerHTML = ("There is another user registered with username " + customerUsername);
                                                          } else if (response === "eDuplicated") {
                                                              errorEmail.innerHTML = ("There is another user registered with email " + customerEmail);
                                                              errorUsername.innerHTML = ("");
                                                          } else if (response === "nDuplicated") {
                                                              errorUsername.innerHTML = ("There is another user registered with username " + customerUsername);
                                                              errorEmail.innerHTML = ("");
                                                          } else {
                                                              error.innerHTML = ("Unknown response from server");
                                                          }

                                                      }).fail(function () {
                                                          error.innerHTML = ("Could not connect to server");
                                                      });


                                                      return false;
                                                  }

                                                  function showModalDialog(title, message) {
                                                      $("#modalTitle").text(title);
                                                      $("#modalBody").text(message);
                                                      $("#modalDialog").modal();
                                                  }

                                                  function showErrorModal(message) {
                                                      showModalDialog("Error", message);
                                                  }

                                                  function showWarningModal(message) {
                                                      showModalDialog("Warning", message);
                                                  }

        </script>
    </body>
</html>
